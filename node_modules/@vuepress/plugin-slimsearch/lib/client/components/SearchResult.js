import{useLocaleConfig as ee,isPlainObject as se,isString as le}from"@vuepress/helper/client";import{useLocalStorage as j,useDebounceFn as re,watchImmediate as ae,useEventListener as te}from"@vueuse/core";import{ref as A,computed as k,shallowRef as ie,onMounted as oe,onUnmounted as ue,defineComponent as ce,toRef as ne,reactive as ve,h as e,watch as de}from"vue";import{useRouteLocale as M,usePageData as me,useRouter as he,RouteLink as U}from"vuepress/client";import{o as x,u as pe,c as ye,l as fe,a as ge}from"../index-CoHE-pvH.js";import{S as He,T as Re,H as Se,a as be,b as $,C as P}from"../icons-DxmX1gti.js";import"../styles/search-result.css";import{store as ke}from"@temp/slimsearch/store.js";import"vuepress/shared";const xe="SLIMSEARCH_QUERY_HISTORY",f=j(xe,[]),Qe=()=>{const{queryHistoryCount:r}=x,a=r>0;return{enabled:a,queryHistories:f,addQueryHistory:i=>{a&&(f.value=Array.from(new Set([i,...f.value.slice(0,r-1)])))},removeQueryHistory:i=>{f.value=[...f.value.slice(0,i),...f.value.slice(i+1)]}}},E=r=>ke[r.id]+("anchor"in r?`#${r.anchor}`:""),Ce="SLIMSEARCH_RESULT_HISTORY",{resultHistoryCount:_}=x,g=j(Ce,[]),qe=()=>{const r=_>0;return{enabled:r,resultHistories:g,addResultHistory:a=>{if(r){const i={link:E(a),display:a.display};"header"in a&&(i.header=a.header),g.value=[i,...g.value.slice(0,_-1)]}},removeResultHistory:a=>{g.value=[...g.value.slice(0,a),...g.value.slice(a+1)]}}},we=r=>{const a=pe(),i=M(),Q=me(),t=A(0),R=k(()=>t.value>0),p=ie([]);return oe(()=>{const{search:y,terminate:C}=ye(),H=re(n=>{const{resultsFilter:S=u=>u,querySplitter:T,suggestionsFilter:q,...w}=a.value;n?(t.value+=1,y(n,i.value,w).then(u=>S(u,n,i.value,Q.value)).then(u=>{t.value-=1,p.value=u}).catch(u=>{console.warn(u),t.value-=1,t.value||(p.value=[])})):p.value=[]},x.searchDelay-x.suggestDelay,{maxWait:5e3});ae([r,i],([n])=>H(n.join(" "))),ue(()=>{C()})}),{isSearching:R,results:p}};var Ie=ce({name:"SearchResult",props:{queries:{type:Array,required:!0},isFocusing:Boolean},emits:["close","updateQuery"],setup(r,{emit:a}){const i=he(),Q=M(),t=ee(fe),{enabled:R,addQueryHistory:p,queryHistories:y,removeQueryHistory:C}=Qe(),{enabled:H,resultHistories:n,addResultHistory:S,removeResultHistory:T}=qe(),q=R||H,w=ne(r,"queries"),{results:u,isSearching:W}=we(w),o=ve({isQuery:!0,index:0}),d=A(0),m=A(0),F=k(()=>q&&(y.value.length>0||n.value.length>0)),I=k(()=>u.value.length>0),L=k(()=>u.value[d.value]||null),Y=()=>{const{isQuery:s,index:l}=o;l===0?(o.isQuery=!s,o.index=s?n.value.length-1:y.value.length-1):o.index=l-1},B=()=>{const{isQuery:s,index:l}=o;l===(s?y.value.length-1:n.value.length-1)?(o.isQuery=!s,o.index=0):o.index=l+1},N=()=>{d.value=d.value>0?d.value-1:u.value.length-1,m.value=L.value.contents.length-1},K=()=>{d.value=d.value<u.value.length-1?d.value+1:0,m.value=0},V=()=>{m.value<L.value.contents.length-1?m.value+=1:K()},z=()=>{m.value>0?m.value-=1:N()},D=s=>s.map(l=>le(l)?l:e(l[0],l[1])),G=s=>{if(s.type==="customField"){const l=ge[s.index]||"$content",[h,c=""]=se(l)?l[Q.value].split("$content"):l.split("$content");return s.display.map(v=>e("div",D([h,...v,c])))}return s.display.map(l=>e("div",D(l)))},b=()=>{d.value=0,m.value=0,a("updateQuery",""),a("close")},J=()=>R?e("div",{class:"slimsearch-records"},e("div",{class:"slimsearch-record"},[e("div",{class:"slimsearch-record-title"},t.value.queryHistory),e("ul",{class:"slimsearch-record-contents",role:"listbox"},y.value.map((s,l)=>{const h=o.isQuery&&o.index===l;return e("li",{class:["slimsearch-record-matches",{active:h}],role:"option","aria-selected":h,onClick:()=>{a("updateQuery",s)}},e("div",[e($,{class:"slimsearch-record-type"}),e("div",{class:"slimsearch-record-content"},s),e("button",{type:"button",class:"slimsearch-remove-icon",title:t.value.remove,"aria-label":t.value.remove,innerHTML:P,onClick:c=>{c.preventDefault(),c.stopPropagation(),C(l)}})]))}))])):null,X=()=>H?e("ul",{class:"slimsearch-records"},e("li",{class:"slimsearch-record"},[e("div",{class:"slimsearch-record-title"},t.value.resultHistory),e("ul",{class:"slimsearch-record-contents",role:"listbox"},n.value.map((s,l)=>{const h=!o.isQuery&&o.index===l;return e("li",{class:["slimsearch-record-matches",{active:h}],role:"option","aria-selected":h},e(U,{to:s.link,onClick:()=>{b()}},()=>[e($,{class:"slimsearch-record-type"}),e("div",{class:"slimsearch-record-content"},[s.header?e("div",{class:"slimsearch-record-content-header"},s.header):null,e("div",s.display.map(c=>D(c)).flat())]),e("button",{type:"button",class:"slimsearch-remove-icon",title:t.value.remove,"aria-label":t.value.remove,innerHTML:P,onClick:c=>{c.preventDefault(),c.stopPropagation(),T(l)}})]))}))])):null;return te("keydown",s=>{if(r.isFocusing){if(I.value){if(s.key==="ArrowUp")z();else if(s.key==="ArrowDown")V();else if(s.key==="Enter"){const l=L.value.contents[m.value];p(r.queries.join(" ")),S(l),i.push(E(l)),b()}}else if(H){if(s.key==="ArrowUp")Y();else if(s.key==="ArrowDown")B();else if(s.key==="Enter"){const{index:l}=o;o.isQuery?(s.preventDefault(),a("updateQuery",y.value[l])):(i.push(n.value[l].link),b())}}}}),de([d,m],()=>{document.querySelector(".slimsearch-record.active .slimsearch-record-matches.active")?.scrollIntoView(!1)},{flush:"post"}),()=>e("div",{id:"slimsearch-results",class:["slimsearch-result-wrapper",{empty:r.queries.length?!I.value:!F.value}]},r.queries.length?W.value?e(He,{hint:t.value.searching}):I.value?e("div",{class:"slimsearch-records",role:"listbox","aria-labeledby":"slimsearch-label"},u.value.map(({title:s,contents:l},h)=>{const c=d.value===h;return e("div",{class:["slimsearch-record",{active:c}],role:"group","aria-selected":c},[e("div",{class:"slimsearch-record-title"},s||t.value.defaultTitle),e("ul",{class:"slimsearch-record-contents"},l.map((v,Z)=>{const O=c&&m.value===Z;return e("li",{class:["slimsearch-record-matches",{active:O}],role:"option","aria-selected":O},e(U,{to:E(v),onClick:()=>{p(r.queries.join(" ")),S(v),b()}},()=>[v.type==="text"?null:e(v.type==="title"?Re:v.type==="heading"?Se:be,{class:"slimsearch-record-type"}),e("div",{class:"slimsearch-record-content"},[v.type==="text"&&v.header?e("div",{class:"slimsearch-record-content-header"},v.header):null,e("div",G(v))])]))}))])})):t.value.emptyResult:q?F.value?[J(),X()]:t.value.emptyHistory:t.value.emptyResult)}});export{Ie as default};
//# sourceMappingURL=SearchResult.js.map
